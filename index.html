<!DOCTYPE html>
<html>
  <head>
    <title>ESP32 Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
  </head>
  <body>
    <h1>Self-Balancing Robot Control</h1>
    <button class="connectButton" onclick="connect()">üîå Connect</button>

    <div class="card-grid">
      <div class="card">
        <h2>Control PID Parameters</h2>
        <label class="gray-label">Kp</label>
        <input type="number" id="kpInput" step="0.1" placeholder="e.g. 10.0"><br>
        <label class="gray-label">Ki</label>
        <input type="number" id="kiInput" step="0.01" placeholder="e.g. 0.0"><br>
        <label class="gray-label">Kd</label>
        <input type="number" id="kdInput" step="0.1" placeholder="e.g. 1.0"><br>
        <label class="gray-label">Target Angle</label>
        <input type="number" id="targetAngleInput" placeholder="e.g. 0"><br>
        <label class="gray-label">Offset Angle</label>
        <input type="number" id="offsetAngleInput" placeholder="e.g. 0"><br><br>
        <button class="onButton" onclick="sendPID()">Send PID Params</button>
        <p>Last sent: <span id="latestValueSent">None</span></p>
      </div>
    </div>

    <script>
      let bleDevice;
      let bleServer;
      let bleServiceFound;
      let ledCharacteristic;
      const SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
      const CHARACTERISTIC_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";

      const latestValueSent = document.getElementById("latestValueSent");

      async function connect() {
        try {
          bleDevice = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'ESP32' }],
            optionalServices: [SERVICE_UUID]
          });

          bleServer = await bleDevice.gatt.connect();
          bleServiceFound = await bleServer.getPrimaryService(SERVICE_UUID);
          ledCharacteristic = await bleServiceFound.getCharacteristic(CHARACTERISTIC_UUID);

          alert("‚úÖ Connected to ESP32!");
        } catch (error) {
          console.error("Connection failed!", error);
          alert("‚ùå Connection failed.");
        }
      }

      async function sendPID() {
        const kp = parseFloat(document.getElementById('kpInput').value);
        const ki = parseFloat(document.getElementById('kiInput').value);
        const kd = parseFloat(document.getElementById('kdInput').value);
        const target = parseFloat(document.getElementById('targetAngleInput').value);
        const offset = parseFloat(document.getElementById('offsetAngleInput').value);

        const dataString = `P${kp},I${ki},D${kd},T${target},O${offset}\n`;
        console.log("Sending PID string:", dataString);

        if (ledCharacteristic) {
          const encoder = new TextEncoder();
          await ledCharacteristic.writeValue(encoder.encode(dataString));
          latestValueSent.textContent = dataString;
        } else {
          alert("‚ùó Not connected to BLE!");
        }
      }
    </script>
  </body>
</html>
